{% extends 'components/layouts/default.html' %}
{% load static %}

{% block content %}

<script defer src="{% static 'assets/js/apexcharts.js' %}"></script>

<!-- Email Campaign System — User Dashboard (scoped to current user) -->
<div x-data="ecsUser">
    <!-- Breadcrumbs -->
    <ul class="flex space-x-2 rtl:space-x-reverse">
        <li>
            <a href="javascript:;" class="text-primary hover:underline">Dashboard</a>
        </li>
        <li class="before:content-['/'] ltr:before:mr-1 rtl:before:ml-1">
            <span>My Email</span>
        </li>
    </ul>

    <div class="pt-5">
        <!-- KPI Cards (User-scoped) -->
        <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-4 mb-6">
            <div class="panel">
                <div class="flex items-center justify-between">
                    <h6 class="text-sm text-white-dark">My Audience Reach</h6>
                    <span class="badge bg-primary/10 text-primary">Unique</span>
                </div>
                <p class="text-2xl font-semibold mt-2" x-text="formatNumber(kpis.audienceReach)"></p>
                <p class="text-xs text-white-dark mt-1">Unique recipients across my audiences</p>
            </div>
            <div class="panel">
                <div class="flex items-center justify-between">
                    <h6 class="text-sm text-white-dark">Sent Today</h6>
                    <span class="badge bg-success/10 text-success">Local</span>
                </div>
                <p class="text-2xl font-semibold mt-2" x-text="formatNumber(kpis.sentToday)"></p>
                <p class="text-xs text-white-dark mt-1">Since 00:00</p>
            </div>
            <div class="panel">
                <div class="flex items-center justify-between">
                    <h6 class="text-sm text-white-dark">Delivery Rate</h6>
                </div>
                <div class="flex items-end gap-3 mt-2">
                    <p class="text-2xl font-semibold" x-text="kpis.deliveryRate + '%' "></p>
                    <span class="text-xs px-2 py-0.5 rounded bg-success/10 text-success" x-text="rateDelta(kpis.deliveryRateDelta)"></span>
                </div>
                <div class="w-full rounded-full h-2 bg-dark-light dark:bg-[#1b2e4b] mt-3">
                    <div class="bg-success h-full rounded-full" :style="'width:' + kpis.deliveryRate + '%' "></div>
                </div>
            </div>
            <div class="panel">
                <div class="flex items-center justify-between">
                    <h6 class="text-sm text-white-dark">Open Rate</h6>
                </div>
                <div class="flex items-end gap-3 mt-2">
                    <p class="text-2xl font-semibold" x-text="kpis.openRate + '%' "></p>
                    <span class="text-xs px-2 py-0.5 rounded bg-info/10 text-info" x-text="rateDelta(kpis.openRateDelta)"></span>
                </div>
                <div class="w-full rounded-full h-2 bg-dark-light dark:bg-[#1b2e4b] mt-3">
                    <div class="bg-info h-full rounded-full" :style="'width:' + kpis.openRate + '%' "></div>
                </div>
            </div>
        </div>

        <!-- Main Row: My Activity + My Engagement -->
        <div class="grid xl:grid-cols-3 gap-6 mb-6">
            <!-- My Sending Activity -->
            <div class="panel h-full xl:col-span-2">
                <div class="flex items-center dark:text-white-light mb-5">
                    <h5 class="font-semibold text-lg">My Sending Activity</h5>
                    <div x-data="dropdown" @click.outside="open = false" class="dropdown ltr:ml-auto rtl:mr-auto">
                        <a href="javascript:;" @click="toggle">
                            <svg class="w-5 h-5 text-black/70 dark:text-white/70 hover:!text-primary" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="5" cy="12" r="2" stroke="currentColor" stroke-width="1.5" />
                                <circle opacity="0.5" cx="12" cy="12" r="2" stroke="currentColor" stroke-width="1.5" />
                                <circle cx="19" cy="12" r="2" stroke="currentColor" stroke-width="1.5" />
                            </svg>
                        </a>
                        <ul x-cloak x-show="open" x-transition x-transition.duration.300ms class="ltr:right-0 rtl:left-0">
                            <li><a href="javascript:;" @click="setRange('24h'); toggle()">Last 24h</a></li>
                            <li><a href="javascript:;" @click="setRange('7d'); toggle()">Last 7d</a></li>
                            <li><a href="javascript:;" @click="setRange('30d'); toggle()">Last 30d</a></li>
                        </ul>
                    </div>
                </div>
                <p class="text-lg dark:text-white-light/90">Throughput
                    <span class="text-primary ml-2" x-text="formatNumber(kpis.sentTotal) + ' sent' "></span>
                </p>
                <div class="relative">
                    <div x-ref="activityChart" class="bg-white dark:bg-black rounded-lg">
                        <div class="min-h-[325px] grid place-content-center bg-white-light/30 dark:bg-dark dark:bg-opacity-[0.08] ">
                            <span class="animate-spin border-2 border-black dark:border-white !border-l-transparent rounded-full w-5 h-5 inline-flex"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Engagement Breakdown -->
            <div class="panel h-full">
                <div class="flex items-center mb-5">
                    <h5 class="font-semibold text-lg dark:text-white-light">My Engagement Breakdown</h5>
                </div>
                <div>
                    <div x-ref="engagementDonut" class="bg-white dark:bg-black rounded-lg">
                        <div class="min-h-[353px] grid place-content-center bg-white-light/30 dark:bg-dark dark:bg-opacity-[0.08] ">
                            <span class="animate-spin border-2 border-black dark:border-white !border-l-transparent rounded-full w-5 h-5 inline-flex"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Row: Today + Summary -->
        <div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
            <!-- Today (hourly) -->
            <div class="panel h-full sm:col-span-2 xl:col-span-1">
                <div class="flex items-center mb-5">
                    <h5 class="font-semibold text-lg dark:text-white-light">Today by Hour
                        <span class="block text-white-dark text-sm font-normal">Sent vs Opens (mine)</span>
                    </h5>
                </div>
                <div>
                    <div x-ref="todayStacked" class="bg-white dark:bg-black rounded-lg">
                        <div class="min-h-[175px] grid place-content-center bg-white-light/30 dark:bg-dark dark:bg-opacity-[0.08] ">
                            <span class="animate-spin border-2 border-black dark:border-white !border-l-transparent rounded-full w-5 h-5 inline-flex"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary rates -->
            <div class="panel h-full">
                <div class="flex items-center dark:text-white-light mb-5">
                    <h5 class="font-semibold text-lg">My Summary</h5>
                </div>
                <div class="space-y-9">
                    <template x-for="row in summaryRows" :key="row.label">
                        <div class="flex items-center">
                            <div class="w-9 h-9 ltr:mr-3 rtl:ml-3">
                                <div :class="row.badgeClass + ' rounded-full w-9 h-9 grid place-content-center'">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3.5 12a8.5 8.5 0 1 1 17 0a8.5 8.5 0 0 1-17 0Z" stroke="currentColor" stroke-width="1.5"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex font-semibold text-white-dark mb-2">
                                    <h6 x-text="row.label"></h6>
                                    <p class="ltr:ml-auto rtl:mr-auto" x-text="row.value"></p>
                                </div>
                                <div class="rounded-full h-2 bg-dark-light dark:bg-[#1b2e4b] shadow">
                                    <div :class="row.progressClass + ' h-full rounded-full'" :style="'width:' + row.percent + '%' "></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- My Delivery Events (was global Deliverability / Queue) -->
            <div class="panel h-full">
                <div class="flex items-center justify-between dark:text-white-light mb-5">
                    <h5 class="font-semibold text-lg">My Delivery Events</h5>
                </div>
                <div class="space-y-6">
                    <template x-for="row in deliverability" :key="row.label + row.when">
                        <div class="flex">
                            <span class="grid place-content-center text-base w-9 h-9 rounded-md" :class="row.badge"></span>
                            <div class="px-3 flex-1">
                                <div x-text="row.label"></div>
                                <div class="text-xs text-white-dark dark:text-gray-500" x-text="row.when"></div>
                            </div>
                            <span :class="row.deltaClass + ' text-base px-1 ltr:ml-auto rtl:mr-auto whitespace-pre'" x-text="row.delta"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Tables (User-scoped) -->
        <div class="grid lg:grid-cols-1 grid-cols-1 gap-6">
            <!-- My Campaigns -->
            <div class="panel h-full w-full">
                <div class="flex items-center justify-between mb-5">
                    <h5 class="font-semibold text-lg dark:text-white-light">My Recent Campaigns</h5>
                    <div class="flex gap-2">
                        <input type="text" placeholder="Search…" class="form-input py-1 h-9" x-model="search" />
                        <select class="form-select py-1 h-9" x-model="statusFilter">
                            <option value="">All</option>
                            <option>Draft</option>
                            <option>Scheduled</option>
                            <option>Sending</option>
                            <option>Completed</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th class="ltr:rounded-l-md rtl:rounded-r-md">Title</th>
                                <th>Status</th>
                                <th>Scheduled</th>
                                <th>Estimated</th>
                                <th>Sent</th>
                                <th>Delivered</th>
                                <th>Open %</th>
                                <th>Click %</th>
                                <th>Bounced</th>
                                <th class="ltr:rounded-r-md rtl:rounded-l-md">Unsub</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="row in filteredCampaigns" :key="row.id">
                                <tr class="text-white-dark hover:text-black dark:hover:text-white-light/90 group">
                                    <td class="min-w-[180px] text-black dark:text-white">
                                        <div class="flex items-center">
                                            <img class="w-8 h-8 rounded-md ltr:mr-3 rtl:ml-3 object-cover" src="{% static 'assets/images/profile-6.jpeg' %}" alt="avatar" />
                                            <span class="whitespace-nowrap" x-text="row.title"></span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge" :class="statusBadge(row.status)" x-text="row.status"></span>
                                    </td>
                                    <td x-text="row.scheduled"></td>
                                    <td x-text="formatNumber(row.estimated)"></td>
                                    <td class="text-primary" x-text="formatNumber(row.sent)"></td>
                                    <td x-text="formatNumber(row.delivered)"></td>
                                    <td x-text="row.openRate + '%' "></td>
                                    <td x-text="row.clickRate + '%' "></td>
                                    <td x-text="row.bounced"></td>
                                    <td x-text="row.unsub"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- My Top Links Clicked -->
            <div class="panel h-full w-full">
                <div class="flex items-center justify-between mb-5">
                    <h5 class="font-semibold text-lg dark:text-white-light">Top Links Clicked (My Campaigns)</h5>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr class="border-b-0">
                                <th class="ltr:rounded-l-md rtl:rounded-r-md">Link</th>
                                <th>Clicks</th>
                                <th>CTR</th>
                                <th class="ltr:rounded-r-md rtl:rounded-l-md">Campaign</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="link in topLinks" :key="link.url">
                                <tr class="text-white-dark hover:text-black dark:hover:text-white-light/90 group">
                                    <td class="min-w-[220px] text-black dark:text-white">
                                        <div class="flex">
                                            <svg class="w-5 h-5 ltr:mr-2 rtl:ml-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M3.9 12a5 5 0 0 1 5-5H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                                <path d="M20.1 12a5 5 0 0 1-5 5H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                                <path d="M9 12h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                            </svg>
                                            <p class="truncate max-w-[320px]" x-text="link.url"></p>
                                        </div>
                                    </td>
                                    <td x-text="formatNumber(link.clicks)"></td>
                                    <td x-text="link.ctr + '%' "></td>
                                    <td x-text="link.campaign"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('ecsUser', () => ({
            // ------- Reactive state (User-scoped) -------
            range: '7d',
            search: '',
            statusFilter: '',
            kpis: {
                audienceReach: 28450,
                sentToday: 1420,
                deliveryRate: 98.1,
                deliveryRateDelta: +0.4,
                openRate: 41.6,
                openRateDelta: +0.8,
                clickRate: 11.9,
                clickRateDelta: +0.2,
                sentTotal: 23100,
            },
            summaryRows: [
                { label: 'Delivered', value: '98.1%', percent: 98.1, badgeClass: 'bg-success-light dark:bg-success text-success dark:text-success-light', progressClass: 'bg-success' },
                { label: 'Opened', value: '41.6%', percent: 41.6, badgeClass: 'bg-info-light dark:bg-info text-info dark:text-info-light', progressClass: 'bg-info' },
                { label: 'Clicked', value: '11.9%', percent: 11.9, badgeClass: 'bg-secondary-light dark:bg-secondary text-secondary dark:text-secondary-light', progressClass: 'bg-secondary' },
            ],
            deliverability: [
                { label: 'Delivered', when: '10:55 AM', delta: '+2,340', deltaClass: 'text-success', badge: 'grid place-content-center w-9 h-9 rounded-md bg-success-light dark:bg-success text-success dark:text-success-light' },
                { label: 'Bounced', when: '10:53 AM', delta: '+18', deltaClass: 'text-danger', badge: 'grid place-content-center w-9 h-9 rounded-md bg-danger-light dark:bg-danger text-danger dark:text-danger-light' },
                { label: 'Unsubscribed', when: '10:48 AM', delta: '+3', deltaClass: 'text-warning', badge: 'grid place-content-center w-9 h-9 rounded-md bg-warning-light dark:bg-warning text-warning dark:text-warning-light' },
                { label: 'Spam Complaints', when: '10:47 AM', delta: '+1', deltaClass: 'text-danger', badge: 'grid place-content-center w-9 h-9 rounded-md bg-black/10 text-black dark:bg-white/10 dark:text-white' },
            ],
            campaigns: [
                { id: 'c1', title: 'August Promo', status: 'Sending', scheduled: 'Aug 28, 11:00', estimated: 5800, sent: 3200, delivered: 3120, openRate: 44.1, clickRate: 13.6, bounced: 42, unsub: 6 },
                { id: 'c2', title: 'New Feature Launch', status: 'Completed', scheduled: 'Aug 27, 14:00', estimated: 9200, sent: 9200, delivered: 9010, openRate: 38.2, clickRate: 12.1, bounced: 110, unsub: 19 },
                { id: 'c3', title: 'Drip #3', status: 'Scheduled', scheduled: 'Aug 29, 09:00', estimated: 2400, sent: 0, delivered: 0, openRate: 0, clickRate: 0, bounced: 0, unsub: 0 },
                { id: 'c4', title: 'Winback – Summer', status: 'Draft', scheduled: '-', estimated: 12050, sent: 0, delivered: 0, openRate: 0, clickRate: 0, bounced: 0, unsub: 0 },
            ],
            topLinks: [
                { url: 'https://example.com/promo', clicks: 740, ctr: 19.4, campaign: 'August Promo' },
                { url: 'https://app.example.com/login', clicks: 405, ctr: 10.1, campaign: 'Feature Launch' },
                { url: 'https://blog.example.com/post', clicks: 190, ctr: 5.6, campaign: 'Drip #3' },
            ],

            // ------- Computed -------
            get filteredCampaigns() {
                const s = this.search.toLowerCase();
                return this.campaigns.filter(r =>
                    (!this.statusFilter || r.status === this.statusFilter) &&
                    (!s || r.title.toLowerCase().includes(s))
                );
            },

            // ------- Lifecycle -------
            init() {
                let isDark = this.$store?.app?.theme === 'dark';
                let isRtl = this.$store?.app?.rtlClass === 'rtl';

                setTimeout(() => {
                    // Activity line (Sent/Delivered) — user scoped
                    this.activityChart = new ApexCharts(this.$refs.activityChart, this.activityChartOptions(isDark, isRtl));
                    this.$refs.activityChart.innerHTML = '';
                    this.activityChart.render();

                    // Engagement donut — user scoped
                    this.engagementDonut = new ApexCharts(this.$refs.engagementDonut, this.engagementDonutOptions(isDark));
                    this.$refs.engagementDonut.innerHTML = '';
                    this.engagementDonut.render();

                    // Today stacked bars (Sent vs Opens)
                    this.todayStacked = new ApexCharts(this.$refs.todayStacked, this.todayStackedOptions());
                    this.$refs.todayStacked.innerHTML = '';
                    this.todayStacked.render();
                }, 250);

                // React to theme/rtl changes
                this.$watch('$store.app.theme', () => {
                    isDark = this.$store.app.theme === 'dark';
                    this.activityChart.updateOptions(this.activityChartOptions(isDark, isRtl));
                    this.engagementDonut.updateOptions(this.engagementDonutOptions(isDark));
                });
                this.$watch('$store.app.rtlClass', () => {
                    isRtl = this.$store.app.rtlClass === 'rtl';
                    this.activityChart.updateOptions(this.activityChartOptions(isDark, isRtl));
                });
            },

            // ------- Actions -------
            setRange(r) { this.range = r; /* TODO: fetch user-scoped data */ },

            // ------- Chart Options -------
            activityChartOptions(isDark, isRtl) {
                return {
                    series: [
                        { name: 'Sent', data: [420, 610, 540, 780, 960, 880, 1040, 1120, 980, 930, 1010, 1180] },
                        { name: 'Delivered', data: [410, 602, 532, 766, 948, 870, 1021, 1105, 970, 920, 998, 1164] },
                    ],
                    chart: { height: 325, type: 'area', fontFamily: 'Nunito, sans-serif', toolbar: { show: false } },
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 2 },
                    dropShadow: { enabled: true, opacity: 0.2, blur: 10, left: -7, top: 22 },
                    colors: isDark ? ['#2196f3', '#00ab55'] : ['#1b55e2', '#00ab55'],
                    labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                    xaxis: {
                        axisBorder: { show: false },
                        axisTicks: { show: false },
                        labels: { offsetX: isRtl ? 2 : 0, offsetY: 5, style: { fontSize: '12px' } },
                    },
                    yaxis: { tickAmount: 6, labels: { formatter: v => Math.round(v) + '' , offsetX: isRtl ? -30 : -10 } , opposite: !!isRtl },
                    grid: { borderColor: isDark ? '#191e3a' : '#e0e6ed', strokeDashArray: 5 },
                    legend: { position: 'top', horizontalAlign: 'right' },
                    tooltip: { shared: true },
                    fill: {
                        type: 'gradient',
                        gradient: { shadeIntensity: 1, inverseColors: false, opacityFrom: isDark ? 0.19 : 0.28, opacityTo: 0.05, stops: isDark ? [100,100] : [45,100] }
                    },
                };
            },
            engagementDonutOptions(isDark) {
                return {
                    series: [416, 119, 34, 9], // Opened, Clicked, Bounced, Unsub (mine)
                    labels: ['Opened', 'Clicked', 'Bounced', 'Unsubscribed'],
                    chart: { type: 'donut', height: 460, fontFamily: 'Nunito, sans-serif' },
                    dataLabels: { enabled: false },
                    stroke: { show: true, width: 25, colors: isDark ? '#0e1726' : '#fff' },
                    colors: isDark ? ['#00bcd4', '#5c1ac3', '#e7515a', '#e2a03f'] : ['#00bcd4', '#5c1ac3', '#e7515a', '#e2a03f'],
                    legend: { position: 'bottom', horizontalAlign: 'center' },
                    plotOptions: { pie: { donut: { size: '65%', labels: { show: true, total: { show: true, label: 'Total', formatter: w => w.globals.seriesTotals.reduce((a,b)=>a+b,0) } } } } },
                    states: { hover: { filter: { type: 'none' } }, active: { filter: { type: 'none' } } },
                };
            },
            todayStackedOptions() {
                return {
                    series: [
                        { name: 'Sent', data: [6, 12, 9, 15, 7, 14, 10, 16, 13, 9, 12, 18] },
                        { name: 'Opens', data: [2, 5, 4, 7, 2, 8, 6, 9, 7, 5, 6, 9] },
                    ],
                    chart: { height: 160, type: 'bar', fontFamily: 'Nunito, sans-serif', toolbar: { show: false }, stacked: true, stackType: '100%' },
                    dataLabels: { enabled: false },
                    stroke: { show: true, width: 1 },
                    colors: ['#1b55e2', '#e0e6ed'],
                    xaxis: { labels: { show: false }, categories: ['1','2','3','4','5','6','7','8','9','10','11','12'] },
                    yaxis: { show: false },
                    fill: { opacity: 1 },
                    plotOptions: { bar: { horizontal: false, columnWidth: '25%' } },
                    legend: { show: false },
                    grid: { show: false, padding: { top: 10, right: -20, bottom: -20, left: -20 } },
                };
            },

            // ------- UI helpers -------
            formatNumber(n) { return new Intl.NumberFormat().format(n); },
            rateDelta(n) { return (n >= 0 ? '+' : '') + n + '%'; },
            statusBadge(st) {
                const map = { Draft: 'badge-outline-dark', Scheduled: 'badge-outline-warning', Sending: 'badge-outline-info', Completed: 'badge-outline-success' };
                return map[st] || 'badge-outline-dark';
            },
        }));
    });
</script>

<!--
BACKEND NOTES (Django, user-scope):
- Filter everything by the current user, e.g. Campaign.objects.filter(created_by=request.user) or owner=request.user.
- Provide a JSON blob (e.g., <script type="application/json" id="ecs-data">{{ dashboard_json|safe }}</script>) and hydrate Alpine state on init.
- Replace the hardcoded kpis/campaigns/links with serialized data from your view.
-->

{% endblock %}
