{% extends 'components/layouts/default.html' %}
{% load static %}
{% block content %}

<div x-data="audiences()" class="space-y-6">
  <!-- Page header -->
  <div class="flex items-start justify-between flex-wrap gap-4">
    <div class="space-y-1">
      <h2 class="text-2xl font-semibold">Audiences</h2>
      <p class="text-white-dark text-sm">Browse, filter, and manage your audiences.</p>
    </div>
    <template x-teleport="body">
                        <div class="fixed inset-0 bg-[black]/60 z-[999] overflow-y-auto hidden" :class="aduienceModal && '!block'">
                            <div class="flex items-center justify-center min-h-screen px-4" @click.self="aduienceModal = false">
                                <div x-show="aduienceModal" x-transition x-transition.duration.300 class="panel border-0 p-0 rounded-lg overflow-hidden md:w-full max-w-lg w-[90%] my-8">
                                    <button type="button" class="absolute top-4 ltr:right-4 rtl:left-4 text-white-dark hover:text-dark" @click="aduienceModal = false">

                                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                    <h3 class="text-lg font-medium bg-[#fbfbfb] dark:bg-[#121c2c] ltr:pl-5 rtl:pr-5 py-3 ltr:pr-[50px] rtl:pl-[50px]" x-text="params.id ? 'Edit Campaign' : 'New Campaign'"></h3>
                                    <div class="p-5 pt-3 pb-0">
                                        <!-- audience Form -->
                                        <form @submit.prevent="saveAudinec()" 
                                            class="bg-white rounded-2xl shadow-xl ring-1 ring-black/5 p-6 sm:p-8 space-y-6 pt-0">
                                        <!-- Grid -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                                            <!-- name -->
                                            <div class="md:col-span-2">
                                            <label for="name" class="block text-sm font-medium mb-1">
                                                Audience Name <span class="text-red-500">*</span>
                                            </label>
                                            <input id="title" type="text"  placeholder="VIP Audience"
                                                    class="form-input w-full"
                                                    x-model.trim="params.name" />
                                            <p class="text-xs text-gray-500 mt-1">Audience Name.</p>
                                            </div>
                                        </div>

                                        <!-- Actions -->
                                        <div class="flex justify-end items-center gap-3 pt-2">
                                            <button type="button" class="btn btn-outline-danger" @click="aduienceModal = false">Cancel</button>
                                            <button type="submit" class="btn btn-primary"
                                                    x-text="params.id ? 'Update Audience' : 'Create Audience'"></button>
                                        </div>
                                        </form>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
    <div class="flex items-center gap-2">
    </div>
  </div>

  <!-- Filters bar (design only; no JS handlers) -->
  <div class="panel p-4">
<form method="GET">
  <div class="w-full mt-2">
    <div class="bg-white/70 backdrop-blur rounded-2xl shadow ring-1 ring-gray-200 p-4 sm:p-5">
      <div class="grid grid-cols-1 gap-3">
        <!-- Search -->
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Search</label>
          <div class="relative">
            <input
              type="text"
              class="form-input w-full pl-9"
              placeholder="Search audiences...."
              name="search"
              x-model="filters.search"
            />
            <div class="absolute ltr:right-[11px] rtl:left-[11px] top-1/2 -translate-y-1/2 peer-focus:text-primary">
              <svg class="mx-auto" width="16" height="16" viewBox="0 0 24 24" fill="none"
                   xmlns="http://www.w3.org/2000/svg">
                <circle cx="11.5" cy="11.5" r="9.5" stroke="currentColor" stroke-width="1.5" opacity="0.5"></circle>
                <path d="M18.5 18.5L22 22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Actions (centered, equal sizes, compact) -->
        <div>
          <div class="flex flex-wrap items-center justify-center gap-3 pt-2">
            <a
              href="/audiences"
              class="btn btn-outline-danger text-sm px-4 py-2 min-w-[120px] text-center"
            >Reset</a>

            <button
              type="submit"
              class="btn btn-outline-primary text-sm px-4 py-2 min-w-[120px]"
            >Filter</button>

            <button
              type="button"
              class="btn text-white bg-gradient-to-r from-[#4361ee] to-[#160f6b] !border-0 !shadow-md hover:shadow-lg !rounded-xl text-sm px-4 py-2 min-w-[140px] flex items-center justify-center gap-2"
              @click="audienceModalOpen"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                   viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"
                   stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <span>New Audience</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

  </div>

  <!-- Table -->
  <div class="panel p-0 border-0 overflow-visible relative">
    <div class="table-responsive" style="overflow-x:auto; overflow-y:visible">
      <table class="table-striped table-hover">
        <thead>
          <tr>
            <th class="!w-10">
              <input type="checkbox" @change="toggleAll($event)" />
            </th>
            <th @click="sortBy('name')" class="cursor-pointer">Name</th>
            <th @click="sortBy('contacts_count')" class="cursor-pointer">Contacts</th>
            <th @click="sortBy('created_at')" class="cursor-pointer">Created</th>
            <th class="!text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="a in audienceList" :key="a.id">
            <tr>
              <td>
                <input type="checkbox" :value="a.id" @change="toggleOne(a.id, $event)" :checked="selected.has(a.id)" />
              </td>
              <td>
                <div class="flex flex-col">
                  <a :href="`{% url 'audience:contact-list' %}?audience=${a.id}`" class="font-medium hover:underline" x-text="a.name"></a>
                </div>
              </td>
              <td x-text="(a.contacts_count ?? 0).toLocaleString()"></td>
              <td x-text="fmtDatetime(a.created_at)"></td>
              <td class="!text-center">
                <!-- Inline action buttons -->
                <div class="inline-flex items-center gap-2">
                  <a :href="`{% url 'audience:contact-list' %}?audience=${a.id}`" class="btn btn-sm btn-outline-primary">View</a>
                  <button  type="button" class="btn btn-sm btn-outline-primary" @click="audienceModalOpen(a)" >Edit</button>
                  <button type="button" class="btn btn-sm btn-outline-danger" @click="remove(a)">Delete</button>
                </div>
              </td>
            </tr>
          </template>
          <tr x-show="!audienceList?.length">
            <td colspan="5" class="text-center py-10 text-white-dark">No audiences found.</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('audiences', () => ({
      defaultParams:{
        id:null,
        name:'',
      },
      params:{
        id:null,
        name:'',
      },
      errors:[],
      aduienceModal:false,
      selected: new Set(),
      audienceList: [],
      sort: { key: 'created_at', dir: 'desc' },
      filters:{
        'search': '{{ request.GET.search|default:"" }}'
      },

      init(){ 
        this.loadData(); 
      },

      async loadData(){
        try {
          const baseUrl = `${APP_URL}/audiences/`;
          let queryString = new URLSearchParams(window.location.search);
          let url = baseUrl + '?' + queryString.toString();
          const res = await fetch(url);
          const data = await res.json();
          this.audienceList = data.results || [];
        } catch (e) {
          this.toast('Error, Unexpected error happened', 'error');
        }
      },

      async saveAudinec(){
          if(!this.params.name)
          {
            this.toast('Audience name is required','error');
          }
        if(this.params.id){
          try{
            let response = await fetch(`${APP_URL}/audiences/${this.params.id}/`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie("csrftoken"),
              },
              body: JSON.stringify(this.params)
          });
            if (!response.ok){
              let data = await response.json();
              if (data) {
                this.errors = data;
                let allErrors = [];
                for (let field in data) {
                    if (Array.isArray(data[field])) {
                        allErrors.push(...data[field]);
                    }
                }
                this.toast(allErrors.join('\n'), 'error');
            } else {
                this.toast('Unexpected error happened', 'error');
            }
            }else{
              this.aduienceModal = false;
              this.loadData();
            }
          }catch(e){
            this.toast('Error, Unexpected error happened','error');
          }
        }else{
          // create aduience``
          try{
            let response = await fetch(`${APP_URL}/audiences/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie("csrftoken"),
              },
              body: JSON.stringify(this.params)
          });
            if (!response.ok){
              let data = await response.json();
              if (data) {
                this.errors = data;
                let allErrors = [];
                for (let field in data) {
                    if (Array.isArray(data[field])) {
                        allErrors.push(...data[field]);
                    }
                }
                this.toast(allErrors.join('\n'), 'error');
            } else {
                this.toast('Unexpected error happened', 'error');
            }
            }else{
              this.aduienceModal = false;
              this.loadData();
            }
          }catch(e){
            this.toast('Error, Unexpected error happened','error');
          }
        }
      },

      audienceModalOpen(audience){
        this.params = this.defaultParams;
        if (audience) {
          this.params = JSON.parse(JSON.stringify(audience));
        }
        this.aduienceModal = true;
      },

      toggleAll(e){
        if (e.target.checked) this.audienceList.forEach(i => this.selected.add(i.id));
        else this.audienceList.forEach(i => this.selected.delete(i.id));
      },
      toggleOne(id, e){ if (e.target.checked) this.selected.add(id); else this.selected.delete(id); },

      sortBy(key){
        if (this.sort.key === key) this.sort.dir = this.sort.dir === 'asc' ? 'desc' : 'asc';
        else { this.sort.key = key; this.sort.dir = 'asc'; }
        const dir = this.sort.dir === 'asc' ? 1 : -1;
        this.audienceList = [...this.audienceList].sort((a,b)=>{
          const va = this.sortValue(a, key), vb = this.sortValue(b, key);
          if (va < vb) return -1*dir; if (va > vb) return 1*dir; return 0;
        });
      },

      remove(row){
        if (!confirm('Delete this audience?')) return;
        this.audienceList = this.audienceList.filter(x => x.id !== row.id);
        this.selected.delete(row.id);
        this.toast('Deleted.');
      },

      // Helpers
      sortValue(row, key){
        if (key === 'contacts_count') return row[key] ?? 0;
        if (key === 'created_at') return new Date(row.created_at || 0).getTime();
        return (row[key] ?? '').toString().toLowerCase();
      },
      fmtDatetime(s){ if (!s) return 'â€”'; const d = new Date(s); return d.toLocaleString(); },
      toast(msg = '', type = 'success'){
        if (window.Swal) {
          const t = window.Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 2500 });
          t.fire({ icon: type, title: msg, padding: '10px 20px' });
        } else { console.log(type.toUpperCase()+':', msg); }
      },
    }));
  });
</script>

{% endblock %}
